#!/usr/bin/env sh

# installation dir
DIR="$(dirname "$(readlink "$0")")"
INSTALLATION_DIR=`dirname "$DIR"`
UTILS_DIR="$INSTALLATION_DIR/utils"

# parse args
INCLUDE_UNTRACKED=false

while [ "$1" != "" ]; do
	PARAM=`echo $1 | awk -F= '{print $1}'`
	VALUE=`echo $1 | awk -F= '{print $2}'`
	case $PARAM in
		-h | --help)
			less "$INSTALLATION_DIR/README.MD"
			exit
			;;
		-u | --untracked)
			INCLUDE_UNTRACKED=true
			;;
		*)
			echo "ERROR: unknown parameter \"$PARAM\""
			usage
			exit 1
			;;
	esac
	shift
done

onexit() {
	# return envs back to original
	unset GSARLANGA_PID
	if [[ -z "${ORIGINAL_GIT_PAGER/ /}" ]]; then
		git config --unset core.pager
	else
		git config core.pager "$ORIGINAL_GIT_PAGER"
	fi
}

# backup lesskey env
ORIGINAL_GIT_PAGER="`git config --get core.pager`"

# set working vars
REVIEW_GIT_PAGER="$UTILS_DIR/less --lesskey-file=$UTILS_DIR/review-lesskey"
git config core.pager "$REVIEW_GIT_PAGER"
export GSARLANGA_PID=$$

# set trap for SIGINT
trap "exit" SIGINT
trap onexit EXIT

# process all modified and deleted files
for file in `git diff --name-only`; do
	export CURRENT_EDITING_FILE="$file"
	git diff -- "$file"
done

# process all added files
if $INCLUDE_UNTRACKED; then
	for file in `git ls-files --others --exclude-standard`; do
		export CURRENT_EDITING_FILE="$file"
		git diff --no-index "$HOME/.git-utils/utils/empty-stub-file" "$file"
	done
fi
